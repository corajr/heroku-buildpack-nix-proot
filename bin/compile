#!/usr/bin/env bash

# Usage:
#
#     $ bin/compile <build-dir> <cache-dir> <env-path>

set -eo pipefail
set -o errtrace
set -o nounset

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

source $DIR/script-common

export_env_dir $ENV_DIR

mkdir -p $CACHE_DIR/bin

download_and_install $CACHE_DIR $BUILD_DIR proot http://static.proot.me/proot-x86_64
download_and_install $CACHE_DIR $BUILD_DIR aws https://raw.githubusercontent.com/timkay/aws/master/aws

# add executables to path
export PATH=$BUILD_DIR/bin:$PATH

export NIX_ROOT_CACHE_PATH=$CACHE_DIR/nix-mnt/$NIX_VERSION_FULL
export REAL_APP_DIR=${REAL_APP_DIR:-/app}

if [ -d "$NIX_ROOT_CACHE_PATH" ]; then
  topic "nix $NIX_VERSION found in cache"
else
  topic "Downloading nix $NIX_VERSION to cache"

  mkdir -p $CACHE_DIR/nix-mnt
  cd $CACHE_DIR/nix-mnt
  fetch nix-${NIX_VERSION}.tar.bz2 http://hydra.nixos.org/build/17897595/download/1/${NIX_VERSION_FULL}.tar.bz2
  tar xjf nix-${NIX_VERSION}.tar.bz2
  echo "Done extracting." | indent
  rm nix-${NIX_VERSION}.tar.bz2
fi

topic "Copying nix to $NIX_ROOT_PATH"
mkdir -p $NIX_ROOT_PATH
rsync -a $NIX_ROOT_CACHE_PATH/ $NIX_ROOT_PATH

$BUILD_DIR/bin/proot -b $NIX_ROOT_PATH:/nix bash $DIR/nix-install-proot $BUILD_DIR

topic "Copying nix to BUILD_DIR"
mkdir -p $BUILD_DIR/nix-mnt
rsync -a $NIX_MNT/ $BUILD_DIR/nix-mnt

if [ -z "${NIX_BUILD_ON_PUSH:-}" ] && [ ! -e /tmp/closure.log ]; then
  topic "Build environment set up."
  echo "To finish building, run:" | indent
  echo "$ heroku run --size=PX build" | indent
  echo
  echo "Then complete the deploy with:" | indent
  echo "$ git commit --amend --no-edit" | indent
  echo "$ git push -f heroku master" | indent
else
  topic "Displaying sizes of build objects"
  du -I .git -ka $BUILD_DIR | sort -n
fi

topic "Make sure your Procfile includes run_proot.sh,"
echo "like so:" | indent
echo "web: run_proot.sh myapp -p \$PORT" | indent